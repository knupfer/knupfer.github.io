#!/bin/sh

echo '---
layout: default
title: Index
---
<div id="table-of-contents2">
<h3>Index</h3>
<div id="text-table-of-contents2">
<ul>' > totalindex;

for FILE in *.org
do
    DATEI=$(echo $FILE | sed 's:\(.*\).org:\1:');
    URL=$(echo /$DATEI | sed 's:-:/: ; s:-:/: ; s:-:/:; s:$:.html:')
    TITLE=$(sed -n '/---/,/---/ s/title: *"*\([^"]*\)"*/\1/p' $DATEI.org);
    FATHER=$(sed -n '/---/,/---/ s/father: *"*\([^"]*\)"*/\1/p' $DATEI.org);

    test -e $DATEI.html &&

    echo '<li><a href="'$URL'">'$TITLE'</a>' >> categorie.$FATHER &&
    sed -n '/<div id="text-table-of-contents">/,/<\/div>/ p' $DATEI.html | 
        tail -n +2 | 
        head -n -1 | 
        sed 's:\(href="\)#:\1'$URL'#:g' >> categorie.$FATHER &&
    sed -n '/---/,/---/ p' $DATEI.org > $DATEI.org.publish &&
    sed 'N;
        s:[(<\/ul>)(<\/dl>)]\n<\/div>/&<p><\/p>/;
        P;
        s/file:\/\///;
        s/<h2>Table of Contents<\/h2>/<h3>Inhaltsverzeichnis<\/h3>/;
        D' $DATEI.html >> $DATEI.org.publish &&
    cat $DATEI.org.publish > ../_posts/$DATEI.html &&
    rm  $DATEI.org.publish;
done

for INDEX in categorie.*
do
    if [ "$(echo $INDEX | sed 's/categorie\(.*\)/\1/')" != '.' ]
    then
        echo '<li><a href="">' $(echo $INDEX | 
            sed 's/categorie\.\(.*\)/\1/') '</a>' '<ul>' >> totalindex;
    else
        echo '<li><a href="">' Verschiedenes '</a>' '<ul>' >> totalindex;
    fi
    cat $INDEX >> totalindex;
    echo '</ul>' >> totalindex;
done

echo '</ul></div></div>' >> totalindex;
mv totalindex  ../totalindex.html;
rm categorie.*;


